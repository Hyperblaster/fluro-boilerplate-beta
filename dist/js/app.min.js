function getMetaKey(stringKey){var metas=document.getElementsByTagName("meta");for(i=0;i<metas.length;i++)if(metas[i].getAttribute("property")==stringKey)return metas[i].getAttribute("content");return""}var app=angular.module("fluro",["ngAnimate","ngResource","ui.router","ngTouch","fluro.config","fluro.content","ui.bootstrap","fluro.validate","formly","formlyBootstrap"]);app.config(function($stateProvider,$httpProvider,FluroProvider,$urlRouterProvider,$locationProvider){var access_token=getMetaKey("fluro_application_key"),api_url=getMetaKey("fluro_url");FluroProvider.set({apiURL:api_url,token:access_token,sessionStorage:!0}),access_token||($httpProvider.defaults.withCredentials=!0),$httpProvider.interceptors.push("FluroAuthentication"),$locationProvider.html5Mode(!0),$urlRouterProvider.otherwise("/"),$stateProvider.state("app",{url:"/","abstract":!0,templateUrl:"routes/outer.html"}),$stateProvider.state("app.search",{url:"",templateUrl:"routes/search/search.html",controller:"SearchController"}),$stateProvider.state("app.create",{url:"create",templateUrl:"routes/create/create.html",controller:"CreateController"}),$stateProvider.state("family_edit",{url:"/family/:id/edit",templateUrl:"routes/family/form.html",controller:"ContentFamilyController",resolve:{item:function($stateParams,FluroContent){return"new"==$stateParams.id?{samePostal:!0}:FluroContent.resource("family").get({id:$stateParams.id,context:"edit"}).$promise}}}),$stateProvider.state("family_view",{url:"/family/:id",templateUrl:"routes/family/view.html",controller:"ContentFamilyController",resolve:{item:function($stateParams,FluroContent){return FluroContent.resource("family").get({id:$stateParams.id,context:"view"}).$promise}}}),$stateProvider.state("contact_edit",{url:"/contact/:id/edit",templateUrl:"routes/contact/form.html",controller:"ContentContactController",resolve:{item:function($stateParams,FluroContent){return"new"==$stateParams.id?{samePostal:!0}:FluroContent.resource("contact").get({id:$stateParams.id,context:"edit"}).$promise}}}),$stateProvider.state("contact_view",{url:"/contact/:id",templateUrl:"routes/contact/view.html",controller:"ContentContactController",resolve:{item:function($stateParams,FluroContent){return FluroContent.resource("contact").get({id:$stateParams.id,context:"view"}).$promise}}}),$urlRouterProvider.otherwise("/")}),app.run(function($rootScope,Asset,$state){$rootScope.asset=Asset,$rootScope.$state=$state,$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){throw error}),FastClick.attach(document.body)}),app.directive("compileHtml",function($compile){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(function(){return scope.$eval(attrs.compileHtml)},function(value){element.html(value),$compile(element.contents())(scope)})}}}),app.directive("contactTimeline",function(){return{restrict:"E",replace:!0,scope:{contactId:"=ngModel"},templateUrl:"contact-timeline/contact-timeline.html",controller:"ContactTimelineController"}}),app.controller("ContactTimelineController",function($scope,FluroContent){$scope.state="timeline",FluroContent.endpoint("info/checkins").query({contact:$scope.contactId}).$promise.then(function(res){$scope.checkins=res}),FluroContent.endpoint("info/interactions").query({contact:$scope.contactId}).$promise.then(function(res){$scope.interactions=res}),FluroContent.endpoint("contact/details/"+$scope.contactId,!0,!0).query().$promise.then(function(res){$scope.details=res}),FluroContent.endpoint("info/assignments").query({contact:$scope.contactId}).$promise.then(function(res){var today=new Date;$scope.pastassignments=_.filter(res,function(event){return new Date(event.startDate)<today}),$scope.upcomingassignments=_.filter(res,function(event){return new Date(event.startDate)>=today})})}),app.directive("addressForm",function(){return{restrict:"E",replace:!0,scope:{model:"=ngModel"},templateUrl:"contacts-address-form/contacts-address-form.html"}}),app.directive("addressView",function(){return{restrict:"E",replace:!0,scope:{model:"=ngModel"},templateUrl:"contacts-address-form/contacts-address-view.html"}}),function(){Date.shortMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Date.longMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],Date.shortDays=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],Date.longDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var replaceChars={d:function(){return(this.getDate()<10?"0":"")+this.getDate()},D:function(){return Date.shortDays[this.getDay()]},j:function(){return this.getDate()},l:function(){return Date.longDays[this.getDay()]},N:function(){return 0==this.getDay()?7:this.getDay()},S:function(){return this.getDate()%10==1&&11!=this.getDate()?"st":this.getDate()%10==2&&12!=this.getDate()?"nd":this.getDate()%10==3&&13!=this.getDate()?"rd":"th"},w:function(){return this.getDay()},z:function(){var d=new Date(this.getFullYear(),0,1);return Math.ceil((this-d)/864e5)},W:function(){var target=new Date(this.valueOf()),dayNr=(this.getDay()+6)%7;target.setDate(target.getDate()-dayNr+3);var firstThursday=target.valueOf();return target.setMonth(0,1),4!==target.getDay()&&target.setMonth(0,1+(4-target.getDay()+7)%7),1+Math.ceil((firstThursday-target)/6048e5)},F:function(){return Date.longMonths[this.getMonth()]},m:function(){return(this.getMonth()<9?"0":"")+(this.getMonth()+1)},M:function(){return Date.shortMonths[this.getMonth()]},n:function(){return this.getMonth()+1},t:function(){var d=new Date;return new Date(d.getFullYear(),d.getMonth(),0).getDate()},L:function(){var year=this.getFullYear();return year%400==0||year%100!=0&&year%4==0},o:function(){var d=new Date(this.valueOf());return d.setDate(d.getDate()-(this.getDay()+6)%7+3),d.getFullYear()},Y:function(){return this.getFullYear()},y:function(){return(""+this.getFullYear()).substr(2)},a:function(){return this.getHours()<12?"am":"pm"},A:function(){return this.getHours()<12?"AM":"PM"},B:function(){return Math.floor(1e3*((this.getUTCHours()+1)%24+this.getUTCMinutes()/60+this.getUTCSeconds()/3600)/24)},g:function(){return this.getHours()%12||12},G:function(){return this.getHours()},h:function(){return((this.getHours()%12||12)<10?"0":"")+(this.getHours()%12||12)},H:function(){return(this.getHours()<10?"0":"")+this.getHours()},i:function(){return(this.getMinutes()<10?"0":"")+this.getMinutes()},s:function(){return(this.getSeconds()<10?"0":"")+this.getSeconds()},u:function(){var m=this.getMilliseconds();return(10>m?"00":100>m?"0":"")+m},e:function(){return"Not Yet Supported"},I:function(){for(var DST=null,i=0;12>i;++i){var d=new Date(this.getFullYear(),i,1),offset=d.getTimezoneOffset();if(null===DST)DST=offset;else{if(DST>offset){DST=offset;break}if(offset>DST)break}}return this.getTimezoneOffset()==DST|0},O:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+"00"},P:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+":00"},T:function(){return this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1")},Z:function(){return 60*-this.getTimezoneOffset()},c:function(){return this.format("Y-m-d\\TH:i:sP")},r:function(){return this.toString()},U:function(){return this.getTime()/1e3}};Date.prototype.format=function(format){var date=this;return format.replace(/(\\?)(.)/g,function(_,esc,chr){return""===esc&&replaceChars[chr]?replaceChars[chr].call(date):chr})}}.call(this),function(){"use strict";function FastClick(layer,options){function bind(method,context){return function(){return method.apply(context,arguments)}}var oldOnClick;if(options=options||{},this.trackingClick=!1,this.trackingClickStart=0,this.targetElement=null,this.touchStartX=0,this.touchStartY=0,this.lastTouchIdentifier=0,this.touchBoundary=options.touchBoundary||10,this.layer=layer,this.tapDelay=options.tapDelay||200,!FastClick.notNeeded(layer)){for(var methods=["onMouse","onClick","onTouchStart","onTouchMove","onTouchEnd","onTouchCancel"],context=this,i=0,l=methods.length;l>i;i++)context[methods[i]]=bind(context[methods[i]],context);deviceIsAndroid&&(layer.addEventListener("mouseover",this.onMouse,!0),layer.addEventListener("mousedown",this.onMouse,!0),layer.addEventListener("mouseup",this.onMouse,!0)),layer.addEventListener("click",this.onClick,!0),layer.addEventListener("touchstart",this.onTouchStart,!1),layer.addEventListener("touchmove",this.onTouchMove,!1),layer.addEventListener("touchend",this.onTouchEnd,!1),layer.addEventListener("touchcancel",this.onTouchCancel,!1),Event.prototype.stopImmediatePropagation||(layer.removeEventListener=function(type,callback,capture){var rmv=Node.prototype.removeEventListener;"click"===type?rmv.call(layer,type,callback.hijacked||callback,capture):rmv.call(layer,type,callback,capture)},layer.addEventListener=function(type,callback,capture){var adv=Node.prototype.addEventListener;"click"===type?adv.call(layer,type,callback.hijacked||(callback.hijacked=function(event){event.propagationStopped||callback(event)}),capture):adv.call(layer,type,callback,capture)}),"function"==typeof layer.onclick&&(oldOnClick=layer.onclick,layer.addEventListener("click",function(event){oldOnClick(event)},!1),layer.onclick=null)}}var deviceIsAndroid=navigator.userAgent.indexOf("Android")>0,deviceIsIOS=/iP(ad|hone|od)/.test(navigator.userAgent),deviceIsIOS4=deviceIsIOS&&/OS 4_\d(_\d)?/.test(navigator.userAgent),deviceIsIOSWithBadTarget=deviceIsIOS&&/OS ([6-9]|\d{2})_\d/.test(navigator.userAgent),deviceIsBlackBerry10=navigator.userAgent.indexOf("BB10")>0;FastClick.prototype.needsClick=function(target){switch(target.nodeName.toLowerCase()){case"button":case"select":case"textarea":if(target.disabled)return!0;break;case"input":if(deviceIsIOS&&"file"===target.type||target.disabled)return!0;break;case"label":case"video":return!0}return/\bneedsclick\b/.test(target.className)},FastClick.prototype.needsFocus=function(target){switch(target.nodeName.toLowerCase()){case"textarea":return!0;case"select":return!deviceIsAndroid;case"input":switch(target.type){case"button":case"checkbox":case"file":case"image":case"radio":case"submit":return!1}return!target.disabled&&!target.readOnly;default:return/\bneedsfocus\b/.test(target.className)}},FastClick.prototype.sendClick=function(targetElement,event){var clickEvent,touch;document.activeElement&&document.activeElement!==targetElement&&document.activeElement.blur(),touch=event.changedTouches[0],clickEvent=document.createEvent("MouseEvents"),clickEvent.initMouseEvent(this.determineEventType(targetElement),!0,!0,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,!1,!1,!1,!1,0,null),clickEvent.forwardedTouchEvent=!0,targetElement.dispatchEvent(clickEvent)},FastClick.prototype.determineEventType=function(targetElement){return deviceIsAndroid&&"select"===targetElement.tagName.toLowerCase()?"mousedown":"click"},FastClick.prototype.focus=function(targetElement){var length;deviceIsIOS&&targetElement.setSelectionRange&&0!==targetElement.type.indexOf("date")&&"time"!==targetElement.type&&"month"!==targetElement.type?(length=targetElement.value.length,targetElement.setSelectionRange(length,length)):targetElement.focus()},FastClick.prototype.updateScrollParent=function(targetElement){var scrollParent,parentElement;if(scrollParent=targetElement.fastClickScrollParent,!scrollParent||!scrollParent.contains(targetElement)){parentElement=targetElement;do{if(parentElement.scrollHeight>parentElement.offsetHeight){scrollParent=parentElement,targetElement.fastClickScrollParent=parentElement;break}parentElement=parentElement.parentElement}while(parentElement)}scrollParent&&(scrollParent.fastClickLastScrollTop=scrollParent.scrollTop)},FastClick.prototype.getTargetElementFromEventTarget=function(eventTarget){return eventTarget.nodeType===Node.TEXT_NODE?eventTarget.parentNode:eventTarget},FastClick.prototype.onTouchStart=function(event){var targetElement,touch,selection;if(event.targetTouches.length>1)return!0;if(targetElement=this.getTargetElementFromEventTarget(event.target),touch=event.targetTouches[0],deviceIsIOS){if(selection=window.getSelection(),selection.rangeCount&&!selection.isCollapsed)return!0;if(!deviceIsIOS4){if(touch.identifier&&touch.identifier===this.lastTouchIdentifier)return event.preventDefault(),!1;this.lastTouchIdentifier=touch.identifier,this.updateScrollParent(targetElement)}}return this.trackingClick=!0,this.trackingClickStart=event.timeStamp,this.targetElement=targetElement,this.touchStartX=touch.pageX,this.touchStartY=touch.pageY,event.timeStamp-this.lastClickTime<this.tapDelay&&event.preventDefault(),!0},FastClick.prototype.touchHasMoved=function(event){var touch=event.changedTouches[0],boundary=this.touchBoundary;return Math.abs(touch.pageX-this.touchStartX)>boundary||Math.abs(touch.pageY-this.touchStartY)>boundary?!0:!1},FastClick.prototype.onTouchMove=function(event){return this.trackingClick?((this.targetElement!==this.getTargetElementFromEventTarget(event.target)||this.touchHasMoved(event))&&(this.trackingClick=!1,this.targetElement=null),!0):!0},FastClick.prototype.findControl=function(labelElement){return void 0!==labelElement.control?labelElement.control:labelElement.htmlFor?document.getElementById(labelElement.htmlFor):labelElement.querySelector("button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea")},FastClick.prototype.onTouchEnd=function(event){var forElement,trackingClickStart,targetTagName,scrollParent,touch,targetElement=this.targetElement;if(!this.trackingClick)return!0;if(event.timeStamp-this.lastClickTime<this.tapDelay)return this.cancelNextClick=!0,!0;if(this.cancelNextClick=!1,this.lastClickTime=event.timeStamp,trackingClickStart=this.trackingClickStart,this.trackingClick=!1,this.trackingClickStart=0,deviceIsIOSWithBadTarget&&(touch=event.changedTouches[0],targetElement=document.elementFromPoint(touch.pageX-window.pageXOffset,touch.pageY-window.pageYOffset)||targetElement,targetElement.fastClickScrollParent=this.targetElement.fastClickScrollParent),targetTagName=targetElement.tagName.toLowerCase(),"label"===targetTagName){if(forElement=this.findControl(targetElement)){if(this.focus(targetElement),deviceIsAndroid)return!1;targetElement=forElement}}else if(this.needsFocus(targetElement))return event.timeStamp-trackingClickStart>100||deviceIsIOS&&window.top!==window&&"input"===targetTagName?(this.targetElement=null,!1):(this.focus(targetElement),this.sendClick(targetElement,event),deviceIsIOS&&"select"===targetTagName||(this.targetElement=null,event.preventDefault()),!1);return deviceIsIOS&&!deviceIsIOS4&&(scrollParent=targetElement.fastClickScrollParent,scrollParent&&scrollParent.fastClickLastScrollTop!==scrollParent.scrollTop)?!0:(this.needsClick(targetElement)||(event.preventDefault(),this.sendClick(targetElement,event)),!1)},FastClick.prototype.onTouchCancel=function(){this.trackingClick=!1,this.targetElement=null},FastClick.prototype.onMouse=function(event){return this.targetElement?event.forwardedTouchEvent?!0:event.cancelable&&(!this.needsClick(this.targetElement)||this.cancelNextClick)?(event.stopImmediatePropagation?event.stopImmediatePropagation():event.propagationStopped=!0,event.stopPropagation(),event.preventDefault(),!1):!0:!0},FastClick.prototype.onClick=function(event){var permitted;return this.trackingClick?(this.targetElement=null,this.trackingClick=!1,!0):"submit"===event.target.type&&0===event.detail?!0:(permitted=this.onMouse(event),permitted||(this.targetElement=null),permitted)},FastClick.prototype.destroy=function(){var layer=this.layer;deviceIsAndroid&&(layer.removeEventListener("mouseover",this.onMouse,!0),layer.removeEventListener("mousedown",this.onMouse,!0),layer.removeEventListener("mouseup",this.onMouse,!0)),layer.removeEventListener("click",this.onClick,!0),layer.removeEventListener("touchstart",this.onTouchStart,!1),layer.removeEventListener("touchmove",this.onTouchMove,!1),layer.removeEventListener("touchend",this.onTouchEnd,!1),layer.removeEventListener("touchcancel",this.onTouchCancel,!1)},FastClick.notNeeded=function(layer){var metaViewport,chromeVersion,blackberryVersion;if("undefined"==typeof window.ontouchstart)return!0;if(chromeVersion=+(/Chrome\/([0-9]+)/.exec(navigator.userAgent)||[,0])[1]){if(!deviceIsAndroid)return!0;if(metaViewport=document.querySelector("meta[name=viewport]")){if(-1!==metaViewport.content.indexOf("user-scalable=no"))return!0;if(chromeVersion>31&&document.documentElement.scrollWidth<=window.outerWidth)return!0}}if(deviceIsBlackBerry10&&(blackberryVersion=navigator.userAgent.match(/Version\/([0-9]*)\.([0-9]*)/),blackberryVersion[1]>=10&&blackberryVersion[2]>=3&&(metaViewport=document.querySelector("meta[name=viewport]")))){if(-1!==metaViewport.content.indexOf("user-scalable=no"))return!0;if(document.documentElement.scrollWidth<=window.outerWidth)return!0}return"none"===layer.style.msTouchAction?!0:!1},FastClick.attach=function(layer,options){return new FastClick(layer,options)},"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return FastClick}):"undefined"!=typeof module&&module.exports?(module.exports=FastClick.attach,module.exports.FastClick=FastClick):window.FastClick=FastClick}(),app.directive("definitionFieldRender",function($compile,$templateCache){return{restrict:"E",replace:!0,scope:{field:"=ngField",model:"=ngModel"},templateUrl:"definition-field-render/definition-field-render.html",link:function($scope,$element){$scope.showField=!0,$scope.viewInModal=function(item){console.log("View in modal",item)},$scope.editInModal=function(item){console.log("Edit in modal",item)};var template="";switch($scope.field.type){case"void":case"null":case"":return $element.empty()}if("group"==$scope.field.type?template=$scope.field.asObject?_.isArray($scope.model[$scope.field.key])?'<div ng-repeat="group in model[field.key]" class="panel panel-default"><div class="panel-heading">{{field.title}} {{$index + 1}}</div><div class="panel-body"><definition-field-render ng-model="group" ng-field="subField" ng-repeat="subField in field.fields"/></div></div>':'<definition-field-render ng-model="model[field.key]" ng-field="subField" ng-repeat="subField in field.fields"/>':'<definition-field-render ng-model="model" ng-field="subField" ng-repeat="subField in field.fields"/>':_.isArray($scope.model[$scope.field.key])&&$scope.model[$scope.field.key].length?template=$templateCache.get("definition-field-render/field-types/multiple-value.html"):$scope.model[$scope.field.key]&&(template=$templateCache.get("definition-field-render/field-types/value.html")),template.length){var cTemplate=$compile(template)($scope),contentHolder=$element.find("[field-transclude]");"group"==$scope.field.type?contentHolder.addClass($scope.field.className).append(cTemplate):($element.addClass($scope.field.className),contentHolder.replaceWith(cTemplate))}else $scope.showField=!1,$element.empty()}}}),app.directive("viewDefinitionFields",function($compile){return{restrict:"E",scope:{definition:"=",dataModel:"=ngModel"},link:function($scope,$element){if($scope.definition){$scope.fields=$scope.definition.fields;var template='<definition-field-render ng-model="dataModel" ng-field="field" ng-repeat="field in fields"></definition-field-render>',cTemplate=$compile(template)($scope);$element.append(cTemplate)}}}}),app.filter("timeago",function(){return function(date){return moment(date).fromNow()}}),app.run(function(formlyConfig){formlyConfig.setType({name:"reference-select",templateUrl:"fluro-admin-content/content-formly/reference-select.html",controller:function($scope){var definition=$scope.to.definition;definition.params||(definition.params={}),$scope.config={canCreate:!0,minimum:definition.minimum,maximum:definition.maximum,type:definition.params.restrictType}},wrapper:["bootstrapLabel","bootstrapHasError"]}),formlyConfig.setType({name:"date-select",templateUrl:"fluro-admin-content/content-formly/date-select.html",wrapper:["bootstrapLabel","bootstrapHasError"]}),formlyConfig.setType({name:"object-editor",templateUrl:"fluro-admin-content/content-formly/object-editor.html",wrapper:["bootstrapLabel","bootstrapHasError"]}),formlyConfig.setType({name:"custom",templateUrl:"fluro-admin-content/content-formly/unknown.html",wrapper:["bootstrapLabel","bootstrapHasError"]}),formlyConfig.setType({name:"code",templateUrl:"fluro-admin-content/content-formly/code.html",wrapper:["bootstrapLabel","bootstrapHasError"],controller:function($scope){var aceEditor;$scope.aceLoaded=function(_editor){aceEditor=_editor;var syntaxName;$scope.to.definition.params&&$scope.to.definition.params.syntax&&(syntaxName=syntaxName=$scope.to.definition.params.syntax),aceEditor&&syntaxName&&aceEditor.getSession().setMode("ace/mode/"+syntaxName)}}}),formlyConfig.setType({name:"wysiwyg",templateUrl:"fluro-admin-content/content-formly/wysiwyg.html",wrapper:["bootstrapLabel","bootstrapHasError"]}),formlyConfig.setType({name:"nested",templateUrl:"fluro-admin-content/content-formly/nested.html",controller:function($scope){$scope.$watch("model[options.key]",function(keyModel){keyModel||($scope.model[$scope.options.key]=[])});var def=$scope.to.definition,minimum=def.minimum,maximum=def.maximum,askCount=def.askCount;minimum||(minimum=0),maximum||(maximum=0),askCount||(askCount=0),minimum&&minimum>askCount&&(askCount=minimum),maximum&&askCount>maximum&&(askCount=maximum),1==maximum&&1==minimum&&$scope.options.key?console.log("Only 1 Please!!!!",$scope.options):(console.log("Fill er up"),askCount&&!$scope.model[$scope.options.key].length&&_.times(askCount,function(){$scope.model[$scope.options.key].push({})})),$scope.firstLine=function(item){var keys=_.chain(item).keys().without("active").filter(function(key){var i=key.indexOf("$$");return-1==i?!0:!1}).slice(0,3).value();return _.at(item,keys).join(",").slice(0,150)},$scope.items=function(){return $scope.model[$scope.options.key]},$scope.canRemove=function(){return minimum?$scope.model[$scope.options.key].length>minimum?!0:void 0:!0},$scope.remove=function(entry){console.log("Pull Entry",entry,$scope.model[$scope.options.key].indexOf(entry)),_.pull($scope.model[$scope.options.key],entry)},$scope.canAdd=function(){return maximum?$scope.model[$scope.options.key].length<maximum?!0:void 0:!0}}}),formlyConfig.setType({name:"list-select",templateUrl:"fluro-admin-content/content-formly/list-select.html",controller:function($scope,FluroValidate){function checkValidity(){var validRequired,validInput=FluroValidate.validate($scope.model[$scope.options.key],definition);$scope.multiple?$scope.to.required&&(validRequired=_.isArray($scope.model[opts.key])&&$scope.model[opts.key].length>0):$scope.to.required&&$scope.model[opts.key]&&(validRequired=!0),$scope.fc.$setValidity("required",validRequired),$scope.fc.$setValidity("validInput",validInput)}function setModel(){$scope.model[opts.key]=angular.copy($scope.multiple?$scope.selection.values:$scope.selection.value),$scope.fc.$setTouched(),checkValidity()}var definition=$scope.to.definition,maximum=(definition.minimum,definition.maximum);$scope.multiple=1!=maximum;var opts=($scope.to,$scope.options);if($scope.selection={values:[],value:null},$scope.contains=function(value){return $scope.multiple?_.contains($scope.selection.values,value):$scope.selection.value==value},$scope.select=function(value){console.log("SELECTION",$scope.selection),$scope.multiple?$scope.selection.values.push(value):$scope.selection.value=value},$scope.deselect=function(value){$scope.multiple?_.pull($scope.selection.values,value):$scope.selection.value=null},$scope.toggle=function(reference){$scope.contains(reference)?$scope.deselect(reference):$scope.select(reference),setModel()},$scope.$watch("model",function(newModelValue){var modelValue;_.keys(newModelValue).length&&(modelValue=newModelValue[opts.key],$scope.multiple?$scope.selection.values=_.isArray(modelValue)?angular.copy(modelValue):[angular.copy(modelValue)]:$scope.selection.value=angular.copy(modelValue))},!0),opts.expressionProperties&&opts.expressionProperties["templateOptions.required"]&&$scope.$watch(function(){return $scope.to.required},function(){checkValidity()}),$scope.to.required)var unwatchFormControl=$scope.$watch("fc",function(newValue){newValue&&(checkValidity(),unwatchFormControl())})},wrapper:["bootstrapLabel","bootstrapHasError"]})}),app.directive("contentFormly",function(FluroContent,FluroContentRetrieval,FluroValidate){return{restrict:"E",transclude:!0,scope:{item:"=ngModel",definition:"="},templateUrl:"fluro-admin-content/content-formly/form.html",link:function($scope){$scope.item||($scope.item={}),$scope.$watch("item",function(item){function addFieldDefinition(array,fieldDefinition){var newField={};newField.key=fieldDefinition.key,fieldDefinition.className&&(newField.className=fieldDefinition.className);var templateOptions={};switch(templateOptions.type="text",templateOptions.label=fieldDefinition.title,templateOptions.description=fieldDefinition.description,templateOptions.definition=fieldDefinition,templateOptions.placeholder=fieldDefinition.placeholder&&fieldDefinition.placeholder.length?fieldDefinition.placeholder:fieldDefinition.description&&fieldDefinition.description.length?fieldDefinition.description:fieldDefinition.title,templateOptions.required=fieldDefinition.minimum>0,fieldDefinition.directive){case"value-select":case"button-select":newField.type="list-select";break;default:newField.type=fieldDefinition.directive}switch(fieldDefinition.type){case"reference":"select"==fieldDefinition.directive&&1==fieldDefinition.maximum?$scope.vm.model[fieldDefinition.key]&&$scope.vm.model[fieldDefinition.key]._id&&($scope.vm.model[fieldDefinition.key]=$scope.vm.model[fieldDefinition.key]._id):newField.type="reference-select";break;case"boolean":newField.type="checkbox";break;case"object":newField.type="object-editor";break;case"date":newField.type="date-select"}if("reference"==fieldDefinition.type)if(fieldDefinition.allowedReferences&&fieldDefinition.allowedReferences.length)templateOptions.options=_.map(fieldDefinition.allowedReferences,function(ref){return{name:ref.title,value:ref._id}});else if(templateOptions.options=[],fieldDefinition.sourceQuery){var queryId=fieldDefinition.sourceQuery;queryId._id&&(queryId=queryId._id);var options={};fieldDefinition.queryTemplate&&(options.template=fieldDefinition.queryTemplate,options.template._id&&(options.template=options.template._id));var promise=FluroContentRetrieval.getQuery(queryId,options);promise.then(function(res){templateOptions.options=_.map(res,function(ref){return{name:ref.title,value:ref._id}})})}else fieldDefinition.params||(fieldDefinition.params={}),FluroContent.resource(fieldDefinition.params.restrictType).query().$promise.then(function(res){templateOptions.options=_.map(res,function(ref){return{name:ref.title,value:ref._id}})});else templateOptions.options=fieldDefinition.options&&fieldDefinition.options.length?fieldDefinition.options:_.map(fieldDefinition.allowedValues,function(val){return{name:val,value:val}});if("input"==fieldDefinition.directive)switch(fieldDefinition.type){case"boolean":newField.type="checkbox"}if(1==fieldDefinition.maximum?"reference"==fieldDefinition.type?fieldDefinition.defaultReferences&&fieldDefinition.defaultReferences.length&&(newField.defaultValue="reference-select"==newField.type?fieldDefinition.defaultReferences[0]:fieldDefinition.defaultReferences[0]._id):fieldDefinition.defaultValues&&fieldDefinition.defaultValues.length&&(newField.defaultValue=fieldDefinition.defaultValues[0]):"reference"==fieldDefinition.type?newField.defaultValue=fieldDefinition.defaultReferences&&fieldDefinition.defaultReferences.length?"reference-select"==newField.type?fieldDefinition.defaultReferences:_.map(fieldDefinition.defaultReferences,function(ref){return ref._id}):[]:fieldDefinition.defaultValues&&fieldDefinition.defaultValues.length&&(newField.defaultValue=fieldDefinition.defaultValues),newField.templateOptions=templateOptions,newField.validators={validInput:function($viewValue,$modelValue){var value=$modelValue||$viewValue,valid=FluroValidate.validate(value,fieldDefinition);return valid}},fieldDefinition.fields&&fieldDefinition.fields.length){var fieldContainer;fieldDefinition.asObject?(newField.type="nested",newField.defaultValue=[],fieldDefinition.key&&1==fieldDefinition.maximum&&1==fieldDefinition.minimum&&(newField.defaultValue={}),newField.data={fields:[]},fieldContainer=newField.data.fields,newField.extras={skipNgModelAttrsManipulator:!0},fieldContainer=newField.data.fields):(newField={fieldGroup:[],className:fieldDefinition.className},fieldContainer=newField.fieldGroup),_.each(fieldDefinition.fields,function(sub){addFieldDefinition(fieldContainer,sub)})}fieldDefinition.hideExpression&&(newField.hideExpression=fieldDefinition.hideExpression),"_contact"!=newField.key&&array.push(newField)}$scope.vm.model=item,$scope.vm.model=$scope.item,$scope.vm.fields=[],$scope.vm.state="ready",$scope.definition&&_.each($scope.definition.fields,function(fieldDefinition){addFieldDefinition($scope.vm.fields,fieldDefinition)})})}}}),app.controller("ContentContactController",function($scope,item,FluroContent){$scope.item=item,$scope.selected={},FluroContent.endpoint("defined/types/contactdetail").query().$promise.then(function(res){FluroContent.endpoint("contact/details/"+$scope.item._id,!0,!0).query().$promise.then(function(details){$scope.details=_.map(details,function(detail){var def=_.find(res,{definitionName:detail.definition});return detail.definitionObject=def,detail})})})}),app.controller("CreateController",function(){}),app.controller("ContentFamilyController",function($scope,item){$scope.item=item}),app.controller("SearchController",function($scope,$state,$sessionStorage,FluroContent){$scope.session=$sessionStorage,$scope.session.search||($scope.session.search={}),$scope.session.selection||($scope.session.selection=[]),$scope.$watch("session.search.terms",function(keywords){$scope.facets=[],!keywords||keywords.length<2||($scope.session.search.status="processing",FluroContent.endpoint("content/search/"+keywords).query({}).$promise.then(function(res){$scope.facets=_.groupBy(res,function(item){return item._type}),$scope.session.search.status="ready"},function(){$scope.session.search.status="ready"}))},!0),$scope.contains=function(contact){var match=_.find($scope.session.selection,{_id:contact._id});return match?!0:void 0},$scope.toggle=function(contact){$scope.contains(contact)?$scope.deselect(contact):$scope.select(contact)},$scope.deselect=function(contact){var match=_.find($scope.session.selection,{_id:contact._id});match&&_.pull($scope.session.selection,match)},$scope.select=function(contact){$scope.contains(contact)||$scope.session.selection.push(contact)},$scope.edit=function(item){switch(item._type){case"family":$state.go("family_edit",{id:item._id});break;case"contact":$state.go("contact_edit",{id:item._id})}},$scope.view=function(item){switch(item._type){case"family":$state.go("family_view",{id:item._id});break;case"contact":$state.go("contact_view",{id:item._id})}}}),app.directive("slider",function(){return{restrict:"E",transclude:!0,replace:!0,template:'<div class="slider"><div class="slider-contents" ng-transclude></div></div>'}});